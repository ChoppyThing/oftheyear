name: Deploy to server

on:
  workflow_run:
    workflows: ["Publish images"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy on server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT || '22' }}
          script: |
            set -e
            cd /opt/oftheyear
            
            # Update image tags in docker-compose.yml
            FRONT_TAG="ghcr.io/choppything/oftheyear-frontend:sha-${{ github.event.workflow_run.head_sha }}"
            BACK_TAG="ghcr.io/choppything/oftheyear-backend:sha-${{ github.event.workflow_run.head_sha }}"
            
            echo "Updating docker-compose.yml with new tags..."
            sed -i -E "s#ghcr.io/choppything/oftheyear-frontend:.*#$FRONT_TAG#g" docker-compose.yml
            sed -i -E "s#ghcr.io/choppything/oftheyear-backend:.*#$BACK_TAG#g" docker-compose.yml
            
            # Run deploy script
            echo "Running deploy.sh..."
            ./deploy.sh
